{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="glass-card">
            <h3 class="mb-4" data-i18n="nav_attendance">Live Camera Feed</h3>
            <div class="video-container position-relative">
                <!-- Client-side Video Element -->
                <video id="video" width="100%" autoplay playsinline></video>
                <canvas id="canvas" style="display:none;"></canvas>

                <!-- Result Overlay -->
                <img id="resultImage" style="display:none; width: 100%; position: absolute; top: 0; left: 0;">
            </div>

            <div class="mt-3 text-center">
                <button id="captureBtn" class="btn btn-primary btn-lg px-5" data-i18n="btn_start_attendance">
                    <i class="fas fa-camera me-2"></i> Mark Attendance
                </button>
                <button id="retakeBtn" class="btn btn-secondary btn-lg px-5" style="display:none;"
                    data-i18n="btn_retake">
                    <i class="fas fa-redo me-2"></i> Retake
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="glass-card mb-4">
            <h4 data-i18n="loc_title"><i class="fas fa-map-marker-alt me-2"></i>Your Location</h4>
            <div id="locationStatus" class="alert alert-info">Getting location...</div>

            <div class="mb-2">
                <strong data-i18n="loc_lat">Latitude:</strong> <span id="latDisplay">--</span>
            </div>
            <div class="mb-2">
                <strong data-i18n="loc_long">Longitude:</strong> <span id="longDisplay">--</span>
            </div>
            <div class="mb-2">
                <strong data-i18n="loc_acc">Accuracy:</strong> <span id="accDisplay">--</span> meters
            </div>
            <button id="refreshLocationBtn" class="btn btn-sm btn-primary mt-2" data-i18n="btn_force_refresh">
                <i class="fas fa-sync me-1"></i> Force Refresh Location
            </button>

            <!-- Interactive Map -->
            <div id="map" style="height: 250px; width: 100%; margin-top: 15px; border-radius: 8px;"></div>
        </div>

        <div class="glass-card">
            <h4 data-i18n="alert_status">Status</h4>
            <div id="statusMessage" class="alert alert-secondary" data-i18n="status_ready">Ready to scan</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet CSS and JS for map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const resultImage = document.getElementById('resultImage');
    const statusMessage = document.getElementById('statusMessage');
    const refreshLocationBtn = document.getElementById('refreshLocationBtn');

    let currentLat = 0;
    let currentLong = 0;
    let watchId = null;
    let map = null;
    let marker = null;

    // Initialize Map
    function initMap() {
        map = L.map('map').setView([17.4359, 78.4483], 13); // Default to Hyderabad

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        marker = L.marker([17.4359, 78.4483]).addTo(map);
        marker.bindPopup('Waiting for your location...').openPopup();
    }

    function updateMap(lat, lng) {
        if (map && marker) {
            map.setView([lat, lng], 15);
            marker.setLatLng([lat, lng]);
            marker.bindPopup(`Your Location<br>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}`).openPopup();
        }
    }

    // 1. Initialize Camera
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user' }
            });
            video.srcObject = stream;
        } catch (err) {
            statusMessage.className = 'alert alert-danger';
            statusMessage.innerText = 'Camera access denied: ' + err.message;
        }
    }

    // 2. Initialize Location with Fallback Mechanism
    function initLocation(forceRefresh = false, useHighAccuracy = true) {
        if (!navigator.geolocation) {
            document.getElementById('locationStatus').className = 'alert alert-danger';
            document.getElementById('locationStatus').innerText = 'Geolocation not supported';
            return;
        }

        const statusDiv = document.getElementById('locationStatus');
        statusDiv.className = 'alert alert-info';
        statusDiv.innerText = useHighAccuracy ? 'Getting precise location (GPS)...' : 'Retrying with standard accuracy...';

        refreshLocationBtn.disabled = true;
        refreshLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Getting Location...';

        // Clear watch if exists
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }

        // Get current position
        navigator.geolocation.getCurrentPosition(
            onLocationSuccess,
            (error) => onLocationError(error, useHighAccuracy),
            {
                enableHighAccuracy: useHighAccuracy,
                timeout: useHighAccuracy ? 20000 : 10000,
                maximumAge: forceRefresh ? 0 : 5000
            }
        );
    }

    function onLocationSuccess(position) {
        currentLat = position.coords.latitude;
        currentLong = position.coords.longitude;

        document.getElementById('latDisplay').innerText = currentLat.toFixed(6);
        document.getElementById('longDisplay').innerText = currentLong.toFixed(6);
        document.getElementById('accDisplay').innerText = position.coords.accuracy.toFixed(1);

        const statusDiv = document.getElementById('locationStatus');
        statusDiv.className = 'alert alert-success';
        statusDiv.innerText = `Location Acquired (${position.coords.accuracy < 50 ? 'High' : 'Standard'} Accuracy: ${position.coords.accuracy.toFixed(1)}m)`;

        refreshLocationBtn.disabled = false;
        refreshLocationBtn.innerHTML = '<i class="fas fa-sync me-1"></i> Force Refresh Location';

        // Update map
        updateMap(currentLat, currentLong);

        // Start watching for updates
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
        }
        watchId = navigator.geolocation.watchPosition(
            (pos) => {
                currentLat = pos.coords.latitude;
                currentLong = pos.coords.longitude;
                document.getElementById('latDisplay').innerText = currentLat.toFixed(6);
                document.getElementById('longDisplay').innerText = currentLong.toFixed(6);
                document.getElementById('accDisplay').innerText = pos.coords.accuracy.toFixed(1);
                updateMap(currentLat, currentLong);
            },
            () => { }, // Ignore watch errors
            {
                enableHighAccuracy: false, // Use standard accuracy for background updates to save battery/reduce errors
                timeout: 20000,
                maximumAge: 10000
            }
        );
    }

    function onLocationError(error, wasHighAccuracy) {
        console.error('Location error:', error);

        // If high accuracy failed, try fallback to standard accuracy
        if (wasHighAccuracy && (error.code === error.TIMEOUT || error.code === error.POSITION_UNAVAILABLE)) {
            console.log('High accuracy failed, falling back to standard accuracy...');
            initLocation(false, false); // Retry with useHighAccuracy = false
            return;
        }

        let errorMsg = '';
        switch (error.code) {
            case error.PERMISSION_DENIED:
                errorMsg = 'Location permission denied. Please enable location in browser settings.';
                break;
            case error.POSITION_UNAVAILABLE:
                errorMsg = 'Location unavailable. Please check GPS/location services.';
                break;
            case error.TIMEOUT:
                errorMsg = 'Location request timed out. Click "Force Refresh" to try again.';
                break;
            default:
                errorMsg = 'Location error: ' + error.message;
        }

        document.getElementById('locationStatus').className = 'alert alert-danger';
        document.getElementById('locationStatus').innerText = errorMsg;
        refreshLocationBtn.disabled = false;
        refreshLocationBtn.innerHTML = '<i class="fas fa-sync me-1"></i> Force Refresh Location';
    }

    refreshLocationBtn.addEventListener('click', () => {
        initLocation(true);  // Force refresh
    });

    // 3. Capture and Send
    captureBtn.addEventListener('click', () => {
        if (currentLat === 0 && currentLong === 0) {
            alert("Waiting for location data. Please allow location access and try again.");
            return;
        }

        // Draw video frame to canvas
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        // Convert to blob
        canvas.toBlob(async (blob) => {
            const formData = new FormData();
            formData.append('image', blob, 'capture.jpg');
            formData.append('lat', currentLat);
            formData.append('long', currentLong);

            statusMessage.className = 'alert alert-info';
            statusMessage.innerText = 'Verifying...';

            try {
                const response = await fetch('/api/mark_attendance', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.status === 'success') {
                    statusMessage.className = 'alert alert-success';
                    statusMessage.innerText = data.message;
                } else if (data.status === 'warning') {
                    statusMessage.className = 'alert alert-warning';
                    statusMessage.innerText = data.message;
                } else {
                    statusMessage.className = 'alert alert-danger';
                    statusMessage.innerText = data.message;
                }

                // Show annotated image
                if (data.image) {
                    resultImage.src = 'data:image/jpeg;base64,' + data.image;
                    resultImage.style.display = 'block';
                    video.style.opacity = '0';

                    captureBtn.style.display = 'none';
                    retakeBtn.style.display = 'inline-block';
                }

            } catch (err) {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerText = 'Network Error: ' + err.message;
            }
        }, 'image/jpeg');
    });

    // 4. Retake
    retakeBtn.addEventListener('click', () => {
        resultImage.style.display = 'none';
        video.style.opacity = '1';
        captureBtn.style.display = 'inline-block';
        retakeBtn.style.display = 'none';
        statusMessage.className = 'alert alert-secondary';
        statusMessage.innerText = 'Ready to scan';
    });

    // Start
    initMap();
    initCamera();
    initLocation();

</script>
{% endblock %}